<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Media Player</title>
    <style>
        body {
            display: grid;
            place-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: oklch(from #1a1a1a l c h);
            color: white;
            font-family: system-ui, sans-serif;
            font-size: .5rem;
        }

        .material-symbols-outlined {
            font-variation-settings:
                'FILL' 0,
                'wght' 400,
                'GRAD' 0,
                'opsz' 2124
        }


        .media-player {
            container-type: inline-size;
            display: grid;
            gap: .25rem;
            padding: .75rem;
            inline-size: 16.5rem;
            max-inline-size: 16.875rem;
            background: oklch(from #2a2a2a l c h);
            border-radius: 2rem;
            box-shadow: 0 0 2px color-mix(in oklch, oklch(from orange l c h) 48%, transparent 52%);
            position: relative;
            /* Establish positioning context */
        }

        .media-player__controls {
            grid-column: 1 / -1;
            display: grid;
            grid-template-columns: repeat(5, minmax(0, 1fr));
            padding: .75rem;
            border-radius: 1.25rem;
            background: oklch(from #333 l c h);
            gap: .5rem;
        }

        .media-player__presets {
            grid-column: 1 / -1;
            display: grid;
            grid-auto-flow: column;
            grid-auto-columns: calc((100% - 2rem) / 5);
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            scroll-padding-left: .75rem;
            padding: .75rem;
            border-radius: 1.25rem;
            background: oklch(from #333 l c h);
            gap: .5rem;
            scrollbar-width: none;
        }

        .media-player__presets::-webkit-scrollbar {
            display: none;
        }

        .media-player__presets>* {
            scroll-snap-align: start;
        }

        .media-player__controls__play {
            grid-column: 5;
        }

        .media-player__controls__option {
            grid-column: 4;
            position: relative;
            z-index: 20;
            /* Ensure it stays above the equalizer popover */
        }

        .media-player__controls__option::after {
            content: '';
            position: absolute;
            inset: -0.0625rem;
            border-radius: inherit;
            border: .0625rem solid oklch(from #5c5c5c l c h);
            opacity: 0;
            pointer-events: none;
            z-index: 1;
        }

        .media-player__controls__option.animate-outline::after {
            animation: outline-expand 0.32s ease-out forwards;
        }

        @keyframes outline-expand {
            0% {
                transform: scale(1);
                opacity: 1;
            }

            100% {
                transform: scale(1.6);
                opacity: 0;
            }
        }

        button {
            padding: .5rem;
            margin: 0;
            border: none;
            border-radius: .5rem;
            background: oklch(from #444 l c h);
            color: white;
            cursor: pointer;
            display: grid;
            place-items: center;
            max-block-size: 3rem;
            max-inline-size: 3rem;
            aspect-ratio: 1;
            outline: .0625rem solid oklch(from #5c5c5c l c h);
        }

        button:hover {
            background: oklch(from #555 l c h);
        }

        .media-player__controls__play {
            background: oklch(from #007bff l c h);
        }

        .media-player__controls__play:hover {
            background: oklch(from #0056b3 l c h);
        }

        /* Fix for Firefox Mobile shrinking images */
        button.has-art {
            padding: 0;
            display: block;
            overflow: hidden;
        }

        button.has-art img {
            display: block;
            inline-size: 100%;
            block-size: 100%;
            object-fit: cover;
            border-radius: inherit;
        }

        .media-player__controls__current img,
        .media-player__presets__preset img {
            inline-size: 100%;
            block-size: 100%;
            object-fit: cover;
            border-radius: inherit;
        }

        .media-player__meta {
            grid-column: 2 / 4;
            padding: 0 .5rem;
            text-align: left;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .media-player__meta__title {
            font-weight: bold;
            font-size: .875rem;
            margin-bottom: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .media-player__meta__artist {
            font-weight: normal;
            font-size: .75rem;
            color: oklch(from #ccc l c h);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .pulse {
            animation: pulse-animation 0.3s ease-in-out;
        }

        @keyframes pulse-animation {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.2);
            }

            100% {
                transform: scale(1);
            }
        }

        /* Equalizer Popover */
        .media-player__equalizer {
            position: absolute;
            inset: 0;
            /* Cover the entire media player */
            background: oklch(from #333 l c h);
            border-radius: inherit;
            /* Find parent border-radius (2rem) */
            padding: 1.5rem;
            /* Increased padding */
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: .5rem;
            align-items: center;
            justify-items: center;
            opacity: 0;
            pointer-events: none;
            transform: translateY(10px);
            transition: opacity 0.2s ease, transform 0.2s ease;
            z-index: 10;
        }

        .media-player__equalizer.active {
            opacity: .98;
            pointer-events: all;
            transform: translateY(0);
        }

        .media-player__equalizer input[type="range"] {
            -webkit-appearance: slider-vertical;
            appearance: slider-vertical;
            width: 100%;
            height: 100%;
            background: transparent;
            cursor: pointer;
            outline: none;
            position: absolute;
            z-index: 10;
            opacity: 0;
            margin: 0;
            inset: 0;
        }

        .media-player__equalizer__slider {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .eq-slider__track {
            position: absolute;
            background: oklch(from #fff l c h / 0.1);
            width: 4px;
            height: 80%;
            border-radius: 4px;
        }

        .eq-slider__fill {
            position: absolute;
            background: oklch(from #eee l c h);
            width: 4px;
            border-radius: 4px;
            box-shadow: 0 0 8px oklch(from #eee l c h / 0.5);
            transition: height 0.05s linear, top 0.05s linear;
        }

        .eq-slider__thumb {
            position: absolute;
            width: 12px;
            height: 12px;
            background: #fff;
            border-radius: 50%;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.8);
            transform: translate(-50%, -50%);
            /* Center on the point */
            left: 50%;
            pointer-events: none;
            transition: top 0.05s linear;
        }
    </style>
</head>

<body>

    <section class="media-player">
        <div class="media-player__controls">
            <button class="media-player__controls__current">
                <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"
                    fill="#e3e3e3">
                    <path
                        d="M360-400h400L622-580l-92 120-62-80-108 140Zm-40 160q-33 0-56.5-23.5T240-320v-480q0-33 23.5-56.5T320-880h480q33 0 56.5 23.5T880-800v480q0 33-23.5 56.5T800-240H320Zm0-80h480v-480H320v480ZM160-80q-33 0-56.5-23.5T80-160v-560h80v560h560v80H160Zm160-720v480-480Z" />
                </svg>
            </button>
            <div class="media-player__meta">
                <div class="media-player__meta__title">Select Track</div>
                <div class="media-player__meta__artist">...</div>
            </div>
            <button class="media-player__controls__option">
                <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"
                    fill="#e3e3e3">
                    <path
                        d="M720-120H280v-520l280-280 50 50q7 7 11.5 19t4.5 23v14l-44 174h258q32 0 56 24t24 56v80q0 7-2 15t-4 15L794-168q-9 20-30 34t-44 14Zm-360-80h360l120-280v-80H480l54-220-174 174v406Zm0-406v406-406Zm-80-34v80H160v360h120v80H80v-520h200Z" />
                </svg>
            </button>
            <button class="media-player__controls__play">
                <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"
                    fill="#e3e3e3">
                    <path d="M320-200v-560l440 280-440 280Zm80-280Zm0 134 210-134-210-134v268Z" />
                </svg>
            </button>
        </div>
        <div class="media-player__presets">
            <!-- Dynamically populated -->
        </div>

        <div class="media-player__equalizer">
            <div class="media-player__equalizer__slider">
                <div class="eq-slider__track"></div>
                <div class="eq-slider__fill"></div>
                <div class="eq-slider__thumb"></div>
                <input type="range" min="-12" max="12" value="3" aria-label="50Hz" step="0.1">
            </div>
            <div class="media-player__equalizer__slider">
                <div class="eq-slider__track"></div>
                <div class="eq-slider__fill"></div>
                <div class="eq-slider__thumb"></div>
                <input type="range" min="-12" max="12" value="6" aria-label="230Hz" step="0.1">
            </div>
            <div class="media-player__equalizer__slider">
                <div class="eq-slider__track"></div>
                <div class="eq-slider__fill"></div>
                <div class="eq-slider__thumb"></div>
                <input type="range" min="-12" max="12" value="-2" aria-label="910Hz" step="0.1">
            </div>
            <div class="media-player__equalizer__slider">
                <div class="eq-slider__track"></div>
                <div class="eq-slider__fill"></div>
                <div class="eq-slider__thumb"></div>
                <input type="range" min="-12" max="12" value="4" aria-label="4kHz" step="0.1">
            </div>
            <div class="media-player__equalizer__slider">
                <div class="eq-slider__track"></div>
                <div class="eq-slider__fill"></div>
                <div class="eq-slider__thumb"></div>
                <input type="range" min="-12" max="12" value="0" aria-label="12kHz" step="0.1">
            </div>
        </div>
    </section>

    <audio id="audio-player" crossorigin="anonymous"></audio>

    <script type="module">
        import { audioLibrary } from '../scripts/AudioLibrary.js';

        const audio = document.getElementById('audio-player');
        // Web Audio API Context
        let audioCtx;
        let source;
        const filters = [];

        const updateSliderVisuals = (input) => {
            const min = parseFloat(input.min);
            const max = parseFloat(input.max);
            const val = parseFloat(input.value);

            // Normalize value to 0-100%
            const pct = ((val - min) / (max - min)) * 100;

            const wrapper = input.parentElement;
            const fill = wrapper.querySelector('.eq-slider__fill');
            const thumb = wrapper.querySelector('.eq-slider__thumb');
            const track = wrapper.querySelector('.eq-slider__track');

            if (!fill || !thumb) return;

            // Visual range is essentially inside the track height (80% of container)
            // But let's map it simply to the container height for now to match input
            // The input covers 100% height.
            // 0% value = Bottom (100% top). 100% value = Top (0% top).
            // Input vertical: max at top, min at bottom.

            // Thumb position
            // top: 0% is max value. top: 100% is min value.
            const topPos = 100 - pct;
            thumb.style.top = `${topPos}%`;

            // Center-Zero Fill Logic
            // Center is 50%
            const center = 50;

            if (pct >= center) {
                // Expanding UP from center
                // Top is current pos, Height is distance from center
                const height = pct - center;
                fill.style.top = `${topPos}%`;
                fill.style.height = `${height}%`;
            } else {
                // Expanding DOWN from center
                // Top is center, Height is distance to bottom
                const height = center - pct;
                fill.style.top = `50%`;
                fill.style.height = `${height}%`;
            }
        };

        const initAudioContext = () => {
            if (audioCtx) return;

            const AudioContext = window.AudioContext || window.webkitAudioContext;
            audioCtx = new AudioContext();

            source = audioCtx.createMediaElementSource(audio);

            // Create filters
            // 50Hz: LowShelf (Deeper Bass)
            const bass = audioCtx.createBiquadFilter();
            bass.type = 'lowshelf';
            bass.frequency.value = 40;

            // 230Hz: Peaking
            const lowMid = audioCtx.createBiquadFilter();
            lowMid.type = 'peaking';
            lowMid.frequency.value = 230;
            lowMid.Q.value = 1;

            // 910Hz: Peaking
            const mid = audioCtx.createBiquadFilter();
            mid.type = 'peaking';
            mid.frequency.value = 910;
            mid.Q.value = 1;

            // 4kHz: Peaking
            const highMid = audioCtx.createBiquadFilter();
            highMid.type = 'peaking';
            highMid.frequency.value = 4000;
            highMid.Q.value = 1;

            // 12kHz: HighShelf (Crisper Treble)
            const treble = audioCtx.createBiquadFilter();
            treble.type = 'highshelf';
            treble.frequency.value = 12000;

            filters.push(bass, lowMid, mid, highMid, treble);

            // Connect nodes
            source.connect(bass);
            bass.connect(lowMid);
            lowMid.connect(mid);
            mid.connect(highMid);
            highMid.connect(treble);
            treble.connect(audioCtx.destination);

            // Apply initial values
            // Apply initial values
            const eqInputs = document.querySelectorAll('.media-player__equalizer input');
            eqInputs.forEach((input, index) => {
                updateSliderVisuals(input);
                if (filters[index]) {
                    filters[index].gain.value = input.value;
                }
            });
        };



        const playButton = document.querySelector('.media-player__controls__play');
        const playIconPath = playButton.querySelector('svg path');
        const titleEl = document.querySelector('.media-player__meta__title');
        const artistEl = document.querySelector('.media-player__meta__artist');
        const currentArtBtn = document.querySelector('.media-player__controls__current');

        const playPath = "M320-200v-560l440 280-440 280Zm80-280Zm0 134 210-134-210-134v268Z";
        const pausePath = "M528-192v-576h240v576H528Zm-336 0v-576h240v576H192Zm408-72h96v-432h-96v432Zm-336 0h96v-432h-96v432Zm0-432v432-432Zm336 0v432-432Z";

        const updatePlayIcon = () => {
            if (audio.paused) {
                playIconPath.setAttribute('d', playPath);
            } else {
                playIconPath.setAttribute('d', pausePath);
            }
        };

        playButton.addEventListener('click', () => {
            initAudioContext();
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }

            if (!audio.src) return;
            if (audio.paused) {
                audio.play();
            } else {
                audio.pause();
            }
            updatePlayIcon();
        });

        audio.addEventListener('play', () => {
            initAudioContext();
            if (audioCtx && audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
            updatePlayIcon();
        });
        audio.addEventListener('pause', updatePlayIcon);
        audio.addEventListener('ended', () => {
            playIconPath.setAttribute('d', playPath);
        });

        const presetsContainer = document.querySelector('.media-player__presets');

        // Populate presets
        const tracks = audioLibrary.getAll();

        const loadTrack = (track, play = false) => {
            audio.src = track.src;
            titleEl.textContent = track.title;
            artistEl.textContent = track.artist;

            if (track.albumArt) {
                currentArtBtn.classList.add('has-art');
                currentArtBtn.style.padding = ''; // Clear inline if any
                currentArtBtn.innerHTML = `<img src="${track.albumArt}" alt="${track.title}">`;
            } else {
                currentArtBtn.classList.remove('has-art');
                currentArtBtn.style.padding = '';
                currentArtBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e3e3e3">
                        <path d="M360-400h400L622-580l-92 120-62-80-108 140Zm-40 160q-33 0-56.5-23.5T240-320v-480q0-33 23.5-56.5T320-880h480q33 0 56.5 23.5T880-800v480q0 33-23.5 56.5T800-240H320Zm0-80h480v-480H320v480ZM160-80q-33 0-56.5-23.5T80-160v-560h80v560h560v80H160Zm160-720v480-480Z" />
                    </svg>
                 `;
            }

            if (play) audio.play();
        }

        // Load first track as default
        if (tracks.length > 0) {
            loadTrack(tracks[0], false);
        }

        const fragment = document.createDocumentFragment();

        tracks.forEach(track => {
            const btn = document.createElement('button');
            btn.className = 'media-player__presets__preset';
            btn.dataset.id = track.id;
            btn.setAttribute('aria-label', `Play ${track.title} by ${track.artist}`);

            if (track.albumArt) {
                btn.classList.add('has-art');
                btn.innerHTML = `<img src="${track.albumArt}" alt="Album art for ${track.title}" loading="lazy">`;
            } else {
                btn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"
                        fill="#e3e3e3">
                        <path
                            d="M360-400h400L622-580l-92 120-62-80-108 140Zm-40 160q-33 0-56.5-23.5T240-320v-480q0-33 23.5-56.5T320-880h480q33 0 56.5 23.5T880-800v480q0 33-23.5 56.5T800-240H320Zm0-80h480v-480H320v480ZM160-80q-33 0-56.5-23.5T80-160v-560h80v560h560v80H160Zm160-720v480-480Z" />
                    </svg>
                `;
            }
            fragment.appendChild(btn);
        });
        presetsContainer.appendChild(fragment);

        // Event Delegation
        presetsContainer.addEventListener('click', (e) => {
            const btn = e.target.closest('.media-player__presets__preset');
            if (!btn) return;

            const id = btn.dataset.id;
            const track = audioLibrary.getById(id);

            if (track) {
                if (audio.src.endsWith(track.src) && !audio.paused) {
                    audio.pause();
                } else {
                    loadTrack(track, true);
                }
            }
        });

        // Option/Like button logic
        const optionButton = document.querySelector('.media-player__controls__option');
        const optionIconPath = optionButton.querySelector('svg path');
        const equalizerPath = "M280-240v-480h80v480h-80ZM440-80v-800h80v800h-80ZM120-400v-160h80v160h-80Zm480 160v-480h80v480h-80Zm160-160v-160h80v160h-80Z";
        const rewindPath = "M480-80q-75 0-140.5-28.5t-114-77q-48.5-48.5-77-114T120-440h80q0 117 81.5 198.5T480-160q117 0 198.5-81.5T760-440q0-117-81.5-198.5T480-720h-6l62 62-56 58-160-160 160-160 56 58-62 62h6q75 0 140.5 28.5t114 77q48.5 48.5-77 114T840-440q0 75-28.5 140.5t-77 114q-48.5 48.5-114 77T480-80ZM360-320v-180h-60v-60h120v240h-60Zm140 0q-17 0-28.5-11.5T460-360v-160q0-17 11.5-28.5T500-560h80q17 0 28.5 11.5T620-520v160q0 17-11.5 28.5T580-320h-80Zm20-60h40v-120h-40v120Z";
        const likePath = "M720-120H280v-520l280-280 50 50q7 7 11.5 19t4.5 23v14l-44 174h258q32 0 56 24t24 56v80q0 7-2 15t-4 15L794-168q-9 20-30 34t-44 14Zm-360-80h360l120-280v-80H480l54-220-174 174v406Zm0-406v406-406Zm-80-34v80H160v360h120v80H80v-520h200Z";
        const likeFilledPath = "M720-120H280v-520l280-280 50 50q7 7 11.5 19t4.5 23v14l-44 174h258q32 0 56 24t24 56v80q0 7-2 15t-4 15L794-168q-9 20-30 34t-44 14Zm-440-520v80H160v360h120v80H80v-520h200Z";

        let longPressTimer;
        let mode = 'like'; // Default mode
        let liked = false;

        const updateIcon = () => {
            if (mode === 'equalizer') {
                optionIconPath.setAttribute('d', equalizerPath);
            } else if (mode === 'rewind') {
                optionIconPath.setAttribute('d', rewindPath);
            } else {
                optionIconPath.setAttribute('d', liked ? likeFilledPath : likePath);
            }

            // Hide equalizer if switching away from it (optional, but good UX)
            // But wait, toggleMode cycles modes. 
            // If we switch MODE away from equalizer, we should probably close the popover if open?
            // The requirement is "when ... equalizer ... is SELECTED".
            // So sticking to the logic that click handles the action.
        };

        const equalizerContainer = document.querySelector('.media-player__equalizer');

        const toggleEqualizerPopover = () => {
            const isActive = equalizerContainer.classList.contains('active');
            if (isActive) {
                equalizerContainer.classList.remove('active');
            } else {
                equalizerContainer.classList.add('active');
            }
        };

        const toggleMode = () => {
            // Ensure popover is closed when switching modes
            equalizerContainer.classList.remove('active');

            if (mode === 'like') {
                mode = 'equalizer';
            } else if (mode === 'equalizer') {
                mode = 'rewind';
            } else {
                mode = 'like';
            }
            if (navigator.vibrate) navigator.vibrate(500);

            // Visual feedback
            optionButton.classList.add('pulse');
            setTimeout(() => optionButton.classList.remove('pulse'), 300);

            updateIcon();
        };

        const toggleLike = () => {
            if (mode === 'like') {
                liked = !liked;
                updateIcon();
            } else if (mode === 'rewind') {
                audio.currentTime = Math.max(0, audio.currentTime - 10);
            } else if (mode === 'equalizer') {
                toggleEqualizerPopover();
            }
        };

        // Close equalizer when clicking outside or engaging other controls?
        // For now, only the toggle closes it or specific logic.
        // Let's ensure switching modes hides it if we want strict mode adherence.
        // But the prompt says "when ... option = equalizer ... and that is selected".
        // This implies the action happens on click.

        let longPressTriggered = false;

        const triggerOutlineAnimation = () => {
            optionButton.classList.remove('animate-outline');
            // Force reflow
            void optionButton.offsetWidth;
            optionButton.classList.add('animate-outline');
        };

        const startPress = (e) => {
            longPressTriggered = false;
            longPressTimer = setTimeout(() => {
                longPressTriggered = true;
                triggerOutlineAnimation();
                toggleMode();
            }, 500); // 500ms for long press
        };

        const cancelPress = () => {
            clearTimeout(longPressTimer);
        };

        optionButton.addEventListener('mousedown', startPress);
        optionButton.addEventListener('touchstart', startPress);
        optionButton.addEventListener('mouseup', cancelPress);
        optionButton.addEventListener('mouseleave', cancelPress);
        optionButton.addEventListener('touchend', cancelPress);
        optionButton.addEventListener('contextmenu', (e) => e.preventDefault());
        optionButton.addEventListener('animationend', () => {
            optionButton.classList.remove('animate-outline');
        });

        optionButton.addEventListener('click', (e) => {
            if (longPressTriggered) return;
            toggleLike();
        });

        // Equalizer Input Listeners
        const eqInputs = document.querySelectorAll('.media-player__equalizer input');

        eqInputs.forEach((input, index) => {
            // Initialize visual state
            updateSliderVisuals(input);

            input.addEventListener('input', (e) => {
                updateSliderVisuals(e.target);
                const value = e.target.value;
                if (filters && filters[index]) {
                    filters[index].gain.value = value;
                }
            });
        });

        // Initialize icon
        updateIcon();
    </script>
</body>

</html>