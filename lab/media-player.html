<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Media Player</title>
    <link rel="stylesheet" href="../styles/components/media-player.css">
    <style>
        .media-player {
            inline-size: 16.5rem;
            max-inline-size: 16.875rem;
            gap: .25rem;
            padding: .75rem;
        }

        .media-player__controls {
            grid-column: 1 / -1;
            grid-template-columns: repeat(5, minmax(0, 1fr));
            padding: .75rem;
        }

        .media-player__presets {
            grid-column: 1 / -1;
            display: grid;
            grid-auto-flow: column;
            grid-auto-columns: calc((100% - 2rem) / 5);
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            scroll-padding-left: .75rem;
            padding: .75rem;
            border-radius: 1.25rem;
            background: oklch(from #333 l c h);
            gap: .5rem;
            scrollbar-width: none;
        }

        .media-player__presets::-webkit-scrollbar {
            display: none;
        }

        .media-player__presets>* {
            scroll-snap-align: start;
        }

        .media-player__controls__play {
            grid-column: 5;
        }

        .media-player__controls__option {
            grid-column: 4;
            transition: opacity 0.2s ease;
        }

        /* Hide Option Button when EQ is open */
        .media-player.is-eq-open .media-player__controls__option {
            opacity: 0;
            pointer-events: none;
        }

        .media-player__meta {
            grid-column: 2 / 4;
            padding: 0 .5rem;
        }

        .media-player__meta__title {
            font-size: .875rem;
        }

        .media-player__meta__artist {
            font-size: .75rem;
        }
    </style>
</head>

<body>

    <section class="media-player">
        <div class="media-player__controls">
            <button class="media-player__controls__current">
                <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"
                    fill="#e3e3e3">
                    <path
                        d="M360-400h400L622-580l-92 120-62-80-108 140Zm-40 160q-33 0-56.5-23.5T240-320v-480q0-33 23.5-56.5T320-880h480q33 0 56.5 23.5T880-800v480q0 33-23.5 56.5T800-240H320Zm0-80h480v-480H320v480ZM160-80q-33 0-56.5-23.5T80-160v-560h80v560h560v80H160Zm160-720v480-480Z" />
                </svg>
            </button>
            <div class="media-player__meta">
                <div class="media-player__meta__title"><span>Select Track</span></div>
                <div class="media-player__meta__artist"><span>...</span></div>
            </div>
            <button class="media-player__controls__option">
                <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"
                    fill="#e3e3e3">
                    <path
                        d="M720-120H280v-520l280-280 50 50q7 7 11.5 19t4.5 23v14l-44 174h258q32 0 56 24t24 56v80q0 7-2 15t-4 15L794-168q-9 20-30 34t-44 14Zm-360-80h360l120-280v-80H480l54-220-174 174v406Zm0-406v406-406Zm-80-34v80H160v360h120v80H80v-520h200Z" />
                </svg>
            </button>
            <button class="media-player__controls__play">
                <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"
                    fill="#e3e3e3">
                    <path d="M320-200v-560l440 280-440 280Zm80-280Zm0 134 210-134-210-134v268Z" />
                </svg>
            </button>
        </div>
        <div class="media-player__presets">
            <!-- Dynamically populated -->
        </div>

        <div class="media-player__equalizer">
            <div class="eq-sidebar">
                <button class="eq-sidebar__btn" id="eq-close-btn" aria-label="Close Equalizer">
                    <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"
                        fill="currentColor">
                        <path
                            d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z" />
                    </svg>
                </button>

                <button class="eq-sidebar__btn" id="eq-power-btn" aria-label="Toggle Equalizer">
                    <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"
                        fill="currentColor">
                        <path
                            d="M480-80q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Zm0-80q54 0 104-17.5t92-50.5L228-676q-33 42-50.5 92T160-480q0 134 93 227t227 93Zm252-124q33-42 50.5-92T800-480q0-134-93-227t-227-93q-54 0-104 17.5T284-732l448 448Z" />
                    </svg>
                </button>

                <button class="eq-sidebar__btn" id="eq-save-btn" aria-label="Save Settings">
                    <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"
                        fill="currentColor">
                        <path
                            d="M840-680v480q0 33-23.5 56.5T760-120H200q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h480l160 160Zm-80 34L646-760H200v560h560v-446ZM480-240q50 0 85-35t35-85q0-50-35-85t-85-35q-50 0-85 35t-35 85q0 50 35 85t85 35ZM240-560h360v-160H240v160Zm-40-86v446-560 114Z" />
                    </svg>
                </button>
                <button class="eq-sidebar__btn" id="eq-load-btn" aria-label="Load Settings">
                    <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"
                        fill="currentColor">
                        <path
                            d="M480-120q-75 0-140.5-28.5t-114-77q-48.5-48.5-77-114T120-480q0-75 28.5-140.5t77-114q48.5-48.5 114-77T480-840q82 0 155.5 35T760-706v-94h80v240H600v-80h110q-41-56-101-88t-129-32q-117 0-198.5 81.5T200-480q0 117 81.5 198.5T480-200q106 0 183.5-68.5T758-440h84q-17 106-102 173t-180 67Z" />
                    </svg>
                </button>
            </div>

            <div class="eq-grid">
                <div class="media-player__equalizer__slider">
                    <div class="eq-slider__wrapper">
                        <div class="eq-slider__track"></div>
                        <div class="eq-slider__fill"></div>
                        <div class="eq-slider__thumb"></div>
                        <input type="range" min="-12" max="12" value="3" aria-label="50Hz" step="0.1">
                    </div>
                    <span class="eq-slider__label">50Hz</span>
                </div>
                <div class="media-player__equalizer__slider">
                    <div class="eq-slider__wrapper">
                        <div class="eq-slider__track"></div>
                        <div class="eq-slider__fill"></div>
                        <div class="eq-slider__thumb"></div>
                        <input type="range" min="-12" max="12" value="6" aria-label="230Hz" step="0.1">
                    </div>
                    <span class="eq-slider__label">230Hz</span>
                </div>
                <div class="media-player__equalizer__slider">
                    <div class="eq-slider__wrapper">
                        <div class="eq-slider__track"></div>
                        <div class="eq-slider__fill"></div>
                        <div class="eq-slider__thumb"></div>
                        <input type="range" min="-12" max="12" value="-2" aria-label="910Hz" step="0.1">
                    </div>
                    <span class="eq-slider__label">910Hz</span>
                </div>
                <div class="media-player__equalizer__slider">
                    <div class="eq-slider__wrapper">
                        <div class="eq-slider__track"></div>
                        <div class="eq-slider__fill"></div>
                        <div class="eq-slider__thumb"></div>
                        <input type="range" min="-12" max="12" value="4" aria-label="4kHz" step="0.1">
                    </div>
                    <span class="eq-slider__label">4kHz</span>
                </div>
                <div class="media-player__equalizer__slider">
                    <div class="eq-slider__wrapper">
                        <div class="eq-slider__track"></div>
                        <div class="eq-slider__fill"></div>
                        <div class="eq-slider__thumb"></div>
                        <input type="range" min="-12" max="12" value="0" aria-label="12kHz" step="0.1">
                    </div>
                    <span class="eq-slider__label">12kHz</span>
                </div>
            </div>
        </div>
        <!-- Preset Popover -->
        <div id="preset-popover" popover="hint">
            <div style="font-weight: bold; margin-bottom: 0.125rem;">Artist Name</div>
            <div style="font-size: 0.65rem; color: #ccc;">Album Name</div>
        </div>
        </div>

        </div>
    </section>



    <audio id="audio-player" crossorigin="anonymous"></audio>

    <script type="module">
        import { audioLibrary } from '../scripts/AudioLibrary.js';
        import { MediaPlayerCore } from '../scripts/media/MediaPlayerCore.js';
        import { Equalizer } from '../scripts/media/Equalizer.js';
        import { UI } from '../scripts/media/MediaPlayerUI.js';
        import { SVG_PATHS } from '../scripts/media/Constants.js';

        const audio = document.getElementById('audio-player');
        const core = new MediaPlayerCore(audio);
        const eq = new Equalizer(audio);

        // UI Elements
        const playButton = document.querySelector('.media-player__controls__play');
        const titleEl = document.querySelector('.media-player__meta__title');
        const artistEl = document.querySelector('.media-player__meta__artist');
        const currentArtBtn = document.querySelector('.media-player__controls__current');
        const presetsContainer = document.querySelector('.media-player__presets');
        const popoverEl = document.getElementById('preset-popover');
        const optionButton = document.querySelector('.media-player__controls__option');
        const optionIconPath = optionButton.querySelector('svg path');
        const equalizerContainer = document.querySelector('.media-player__equalizer');
        const eqInputs = document.querySelectorAll('.media-player__equalizer input');

        // Mode State
        let mode = 'like'; // like, equalizer, rewind
        let liked = false;
        let isEqOn = true;
        let activeAnchorBtn = null;

        // --- Core Subscriptions ---
        core.subscribe((event, data) => {
            if (event === 'play' || event === 'pause' || event === 'ended') {
                if (event === 'play') eq.init();
                UI.updatePlayIcon(playButton, audio.paused);
            }
            if (event === 'trackChanged') {
                UI.updateTrackInfo({ title: titleEl, artist: artistEl, artBtn: currentArtBtn }, data);
            }
        });

        // --- Init ---
        // Load first track
        core.loadTrack(0);

        // Populate Presets
        const fragment = document.createDocumentFragment();
        core.tracks.forEach(track => {
            const btn = document.createElement('button');
            btn.className = 'media-player__presets__preset';
            btn.dataset.id = track.id;
            btn.setAttribute('aria-label', `Play ${track.title} by ${track.artist}`);

            if (track.albumArt) {
                btn.classList.add('has-art');
                btn.innerHTML = `<img src="${track.albumArt}" alt="Album art for ${track.title}" loading="lazy">`;
            } else {
                btn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e3e3e3">
                        <path d="M360-400h400L622-580l-92 120-62-80-108 140Zm-40 160q-33 0-56.5-23.5T240-320v-480q0-33 23.5-56.5T320-880h480q33 0 56.5 23.5T880-800v480q0 33-23.5 56.5T800-240H320Zm0-80h480v-480H320v480ZM160-80q-33 0-56.5-23.5T80-160v-560h80v560h560v80H160Zm160-720v480-480Z" />
                    </svg>
                `;
            }
            fragment.appendChild(btn);
        });
        presetsContainer.appendChild(fragment);

        // --- Event Handlers ---
        playButton.addEventListener('click', () => {
            eq.init();
            eq.resume();
            core.togglePlay();
        });

        // Option Button Logic
        const ICON_PATHS = {
            equalizer: "M280-240v-480h80v480h-80ZM440-80v-800h80v800h-80ZM120-400v-160h80v160h-80Zm480 160v-480h80v480h-80Zm160-160v-160h80v160h-80Z",
            rewind: "M480-80q-75 0-140.5-28.5t-114-77q-48.5-48.5-77-114T120-440h80q0 117 81.5 198.5T480-160q117 0 198.5-81.5T760-440q0-117-81.5-198.5T480-720h-6l62 62-56 58-160-160 160-160 56 58-62 62h6q75 0 140.5 28.5t114 77q48.5 48.5-77 114T840-440q0 75-28.5 140.5t-77 114q-48.5 48.5-114 77T480-80ZM360-320v-180h-60v-60h120v240h-60Zm140 0q-17 0-28.5-11.5T460-360v-160q0-17 11.5-28.5T500-560h80q17 0 28.5 11.5T620-520v160q0 17-11.5 28.5T580-320h-80Zm20-60h40v-120h-40v120Z",
            like: SVG_PATHS.LIKE,
            likeFilled: SVG_PATHS.LIKE_FILLED
        };

        const updateOptionIcon = () => {
            if (mode === 'equalizer') optionIconPath.setAttribute('d', ICON_PATHS.equalizer);
            else if (mode === 'rewind') optionIconPath.setAttribute('d', ICON_PATHS.rewind);
            else optionIconPath.setAttribute('d', liked ? ICON_PATHS.likeFilled : ICON_PATHS.like);
        };

        const toggleMode = () => {
            equalizerContainer.classList.remove('active');
            if (mode === 'like') mode = 'equalizer';
            else if (mode === 'equalizer') mode = 'rewind';
            else mode = 'like';

            if (navigator.vibrate) navigator.vibrate(500);
            optionButton.classList.add('pulse');
            setTimeout(() => optionButton.classList.remove('pulse'), 300);
            updateOptionIcon();
        };

        const handleOptionClick = () => {
            if (mode === 'like') {
                liked = !liked;
                updateOptionIcon();
            } else if (mode === 'rewind') {
                audio.currentTime = Math.max(0, audio.currentTime - 10);
            } else if (mode === 'equalizer') {
                const isActive = equalizerContainer.classList.toggle('active');
                document.querySelector('.media-player').classList.toggle('is-eq-open', isActive);
            }
        };

        let longPressTimer;
        let longPressTriggered = false;

        optionButton.addEventListener('mousedown', () => {
            longPressTriggered = false;
            longPressTimer = setTimeout(() => {
                longPressTriggered = true;
                optionButton.classList.add('animate-outline');
                toggleMode();
            }, 500);
        });

        const stopOptionPress = () => clearTimeout(longPressTimer);
        ['mouseup', 'mouseleave', 'touchend'].forEach(evt => optionButton.addEventListener(evt, stopOptionPress));

        optionButton.addEventListener('click', () => {
            if (longPressTriggered) return;
            handleOptionClick();
        });

        // --- Presets & Popover ---
        let pressTimer;
        let isLongPress = false;

        const handlePresetPressStart = (e) => {
            const btn = e.target.closest('.media-player__presets__preset');
            if (!btn) return;
            isLongPress = false;
            pressTimer = setTimeout(() => {
                isLongPress = true;
                const track = audioLibrary.getById(btn.dataset.id);
                UI.showPopover(popoverEl, btn, track);
                activeAnchorBtn = btn;
            }, 500);
        };

        const handlePresetPressEnd = () => {
            clearTimeout(pressTimer);
            if (isLongPress) {
                setTimeout(() => UI.hidePopover(popoverEl, activeAnchorBtn), 1500);
            }
        };

        presetsContainer.addEventListener('mousedown', handlePresetPressStart);
        presetsContainer.addEventListener('mouseup', handlePresetPressEnd);
        presetsContainer.addEventListener('mouseleave', handlePresetPressEnd);

        presetsContainer.addEventListener('click', (e) => {
            if (isLongPress) return;
            const btn = e.target.closest('.media-player__presets__preset');
            if (!btn) return;
            const track = audioLibrary.getById(btn.dataset.id);
            if (track) {
                if (audio.src.endsWith(track.src) && !audio.paused) {
                    core.pause();
                } else {
                    core.loadTrack(core.tracks.indexOf(track));
                    core.play();
                }
            }
        });

        // --- Equalizer Features ---
        const powerBtn = document.getElementById('eq-power-btn');
        const saveBtn = document.getElementById('eq-save-btn');
        const loadBtn = document.getElementById('eq-load-btn');
        const closeBtn = document.getElementById('eq-close-btn');

        eqInputs.forEach((input, index) => {
            UI.updateSliderVisuals(input);
            input.addEventListener('input', (e) => {
                UI.updateSliderVisuals(e.target);
                if (isEqOn) eq.setGain(index, e.target.value);
            });
        });

        closeBtn.addEventListener('click', () => {
            equalizerContainer.classList.remove('active');
            document.querySelector('.media-player').classList.remove('is-eq-open');
        });

        powerBtn.addEventListener('click', () => {
            isEqOn = !isEqOn;
            powerBtn.classList.toggle('active', isEqOn);
            equalizerContainer.classList.toggle('disabled', !isEqOn);
            eqInputs.forEach((input, index) => {
                eq.setGain(index, isEqOn ? input.value : 0);
            });
        });

        saveBtn.addEventListener('click', () => {
            const settings = Array.from(eqInputs).map(i => i.value);
            localStorage.setItem('rj-eq-settings', JSON.stringify(settings));
            saveBtn.classList.add('active');
            setTimeout(() => saveBtn.classList.remove('active'), 1000);
        });

        loadBtn.addEventListener('click', () => {
            const saved = JSON.parse(localStorage.getItem('rj-eq-settings') || '[]');
            eqInputs.forEach((input, index) => {
                if (saved[index] !== undefined) {
                    input.value = saved[index];
                    UI.updateSliderVisuals(input);
                    if (isEqOn) eq.setGain(index, input.value);
                }
            });
            loadBtn.classList.add('active');
            setTimeout(() => loadBtn.classList.remove('active'), 1000);
        });

        // Auto Load
        const savedSettings = JSON.parse(localStorage.getItem('rj-eq-settings') || '[]');
        eqInputs.forEach((input, index) => {
            if (savedSettings[index] !== undefined) {
                input.value = savedSettings[index];
                UI.updateSliderVisuals(input);
            }
        });

        updateOptionIcon();
    </script>
</body>

</html>