<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Media Player</title>
    <style>
        body {
            display: grid;
            place-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: oklch(from #1a1a1a l c h);
            color: white;
            font-family: system-ui, sans-serif;
            font-size: .5rem;
        }

        .material-symbols-outlined {
            font-variation-settings:
                'FILL' 0,
                'wght' 400,
                'GRAD' 0,
                'opsz' 2124
        }


        .media-player {
            container-type: inline-size;
            display: grid;
            gap: .25rem;
            padding: .75rem;
            inline-size: 16.5rem;
            max-inline-size: 16.875rem;
            background: oklch(from #2a2a2a l c h);
            border-radius: 2rem;
            box-shadow: 0 0 2px color-mix(in oklch, oklch(from orange l c h) 48%, transparent 52%);
        }

        .media-player__controls {
            grid-column: 1 / -1;
            display: grid;
            grid-template-columns: repeat(5, minmax(0, 1fr));
            padding: .75rem;
            border-radius: 1.25rem;
            background: oklch(from #333 l c h);
            gap: .5rem;
        }

        .media-player__presets {
            grid-column: 1 / -1;
            display: grid;
            grid-auto-flow: column;
            grid-auto-columns: calc((100% - 2rem) / 5);
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            scroll-padding-left: .75rem;
            padding: .75rem;
            border-radius: 1.25rem;
            background: oklch(from #333 l c h);
            gap: .5rem;
            scrollbar-width: none;
        }

        .media-player__presets::-webkit-scrollbar {
            display: none;
        }

        .media-player__presets>* {
            scroll-snap-align: start;
        }

        .media-player__controls__play {
            grid-column: 5;
        }

        .media-player__controls__option {
            grid-column: 4;
            position: relative;
        }

        .media-player__controls__option::after {
            content: '';
            position: absolute;
            inset: -0.0625rem;
            border-radius: inherit;
            border: .0625rem solid oklch(from #5c5c5c l c h);
            opacity: 0;
            pointer-events: none;
            z-index: 1;
        }

        .media-player__controls__option.animate-outline::after {
            animation: outline-expand 0.32s ease-out forwards;
        }

        @keyframes outline-expand {
            0% {
                transform: scale(1);
                opacity: 1;
            }

            100% {
                transform: scale(1.6);
                opacity: 0;
            }
        }

        button {
            padding: .5rem;
            margin: 0;
            border: none;
            border-radius: .5rem;
            background: oklch(from #444 l c h);
            color: white;
            cursor: pointer;
            display: grid;
            place-items: center;
            max-block-size: 3rem;
            max-inline-size: 3rem;
            aspect-ratio: 1;
            outline: .0625rem solid oklch(from #5c5c5c l c h);
        }

        button:hover {
            background: oklch(from #555 l c h);
        }

        .media-player__controls__play {
            background: oklch(from #007bff l c h);
        }

        .media-player__controls__play:hover {
            background: oklch(from #0056b3 l c h);
        }

        /* Fix for Firefox Mobile shrinking images */
        button.has-art {
            padding: 0;
            display: block;
            overflow: hidden;
        }

        button.has-art img {
            display: block;
            inline-size: 100%;
            block-size: 100%;
            object-fit: cover;
            border-radius: inherit;
        }

        .media-player__controls__current img,
        .media-player__presets__preset img {
            inline-size: 100%;
            block-size: 100%;
            object-fit: cover;
            border-radius: inherit;
        }

        .media-player__meta {
            grid-column: 2 / 4;
            padding: 0 .5rem;
            text-align: left;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .media-player__meta__title {
            font-weight: bold;
            font-size: .875rem;
            margin-bottom: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .media-player__meta__artist {
            font-weight: normal;
            font-size: .75rem;
            color: oklch(from #ccc l c h);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .pulse {
            animation: pulse-animation 0.3s ease-in-out;
        }

        @keyframes pulse-animation {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.2);
            }

            100% {
                transform: scale(1);
            }
        }
    </style>
</head>

<body>

    <section class="media-player">
        <div class="media-player__controls">
            <button class="media-player__controls__current">
                <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"
                    fill="#e3e3e3">
                    <path
                        d="M360-400h400L622-580l-92 120-62-80-108 140Zm-40 160q-33 0-56.5-23.5T240-320v-480q0-33 23.5-56.5T320-880h480q33 0 56.5 23.5T880-800v480q0 33-23.5 56.5T800-240H320Zm0-80h480v-480H320v480ZM160-80q-33 0-56.5-23.5T80-160v-560h80v560h560v80H160Zm160-720v480-480Z" />
                </svg>
            </button>
            <div class="media-player__meta">
                <div class="media-player__meta__title">Select Track</div>
                <div class="media-player__meta__artist">...</div>
            </div>
            <button class="media-player__controls__option">
                <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"
                    fill="#e3e3e3">
                    <path
                        d="M720-120H280v-520l280-280 50 50q7 7 11.5 19t4.5 23v14l-44 174h258q32 0 56 24t24 56v80q0 7-2 15t-4 15L794-168q-9 20-30 34t-44 14Zm-360-80h360l120-280v-80H480l54-220-174 174v406Zm0-406v406-406Zm-80-34v80H160v360h120v80H80v-520h200Z" />
                </svg>
            </button>
            <button class="media-player__controls__play">
                <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"
                    fill="#e3e3e3">
                    <path d="M320-200v-560l440 280-440 280Zm80-280Zm0 134 210-134-210-134v268Z" />
                </svg>
            </button>
        </div>
        <div class="media-player__presets">
            <!-- Dynamically populated -->
        </div>
    </section>

    <audio id="audio-player"></audio>

    <script type="module">
        import { audioLibrary } from '../scripts/AudioLibrary.js';

        const audio = document.getElementById('audio-player');
        const playButton = document.querySelector('.media-player__controls__play');
        const playIconPath = playButton.querySelector('svg path');
        const titleEl = document.querySelector('.media-player__meta__title');
        const artistEl = document.querySelector('.media-player__meta__artist');
        const currentArtBtn = document.querySelector('.media-player__controls__current');

        const playPath = "M320-200v-560l440 280-440 280Zm80-280Zm0 134 210-134-210-134v268Z";
        const pausePath = "M528-192v-576h240v576H528Zm-336 0v-576h240v576H192Zm408-72h96v-432h-96v432Zm-336 0h96v-432h-96v432Zm0-432v432-432Zm336 0v432-432Z";

        const updatePlayIcon = () => {
            if (audio.paused) {
                playIconPath.setAttribute('d', playPath);
            } else {
                playIconPath.setAttribute('d', pausePath);
            }
        };

        playButton.addEventListener('click', () => {
            if (!audio.src) return;
            if (audio.paused) {
                audio.play();
            } else {
                audio.pause();
            }
            updatePlayIcon();
        });

        audio.addEventListener('play', updatePlayIcon);
        audio.addEventListener('pause', updatePlayIcon);
        audio.addEventListener('ended', () => {
            playIconPath.setAttribute('d', playPath);
        });

        const presetsContainer = document.querySelector('.media-player__presets');

        // Populate presets
        const tracks = audioLibrary.getAll();

        const loadTrack = (track, play = false) => {
            audio.src = track.src;
            titleEl.textContent = track.title;
            artistEl.textContent = track.artist;

            if (track.albumArt) {
                currentArtBtn.classList.add('has-art');
                currentArtBtn.style.padding = ''; // Clear inline if any
                currentArtBtn.innerHTML = `<img src="${track.albumArt}" alt="${track.title}">`;
            } else {
                currentArtBtn.classList.remove('has-art');
                currentArtBtn.style.padding = '';
                currentArtBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e3e3e3">
                        <path d="M360-400h400L622-580l-92 120-62-80-108 140Zm-40 160q-33 0-56.5-23.5T240-320v-480q0-33 23.5-56.5T320-880h480q33 0 56.5 23.5T880-800v480q0 33-23.5 56.5T800-240H320Zm0-80h480v-480H320v480ZM160-80q-33 0-56.5-23.5T80-160v-560h80v560h560v80H160Zm160-720v480-480Z" />
                    </svg>
                 `;
            }

            if (play) audio.play();
        }

        // Load first track as default
        if (tracks.length > 0) {
            loadTrack(tracks[0], false);
        }

        const fragment = document.createDocumentFragment();

        tracks.forEach(track => {
            const btn = document.createElement('button');
            btn.className = 'media-player__presets__preset';
            btn.dataset.id = track.id;
            btn.setAttribute('aria-label', `Play ${track.title} by ${track.artist}`);

            if (track.albumArt) {
                btn.classList.add('has-art');
                btn.innerHTML = `<img src="${track.albumArt}" alt="Album art for ${track.title}" loading="lazy">`;
            } else {
                btn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"
                        fill="#e3e3e3">
                        <path
                            d="M360-400h400L622-580l-92 120-62-80-108 140Zm-40 160q-33 0-56.5-23.5T240-320v-480q0-33 23.5-56.5T320-880h480q33 0 56.5 23.5T880-800v480q0 33-23.5 56.5T800-240H320Zm0-80h480v-480H320v480ZM160-80q-33 0-56.5-23.5T80-160v-560h80v560h560v80H160Zm160-720v480-480Z" />
                    </svg>
                `;
            }
            fragment.appendChild(btn);
        });
        presetsContainer.appendChild(fragment);

        // Event Delegation
        presetsContainer.addEventListener('click', (e) => {
            const btn = e.target.closest('.media-player__presets__preset');
            if (!btn) return;

            const id = btn.dataset.id;
            const track = audioLibrary.getById(id);

            if (track) {
                if (audio.src.endsWith(track.src) && !audio.paused) {
                    audio.pause();
                } else {
                    loadTrack(track, true);
                }
            }
        });

        // Option/Like button logic
        const optionButton = document.querySelector('.media-player__controls__option');
        const optionIconPath = optionButton.querySelector('svg path');
        const equalizerPath = "M280-240v-480h80v480h-80ZM440-80v-800h80v800h-80ZM120-400v-160h80v160h-80Zm480 160v-480h80v480h-80Zm160-160v-160h80v160h-80Z";
        const rewindPath = "M480-80q-75 0-140.5-28.5t-114-77q-48.5-48.5-77-114T120-440h80q0 117 81.5 198.5T480-160q117 0 198.5-81.5T760-440q0-117-81.5-198.5T480-720h-6l62 62-56 58-160-160 160-160 56 58-62 62h6q75 0 140.5 28.5t114 77q48.5 48.5-77 114T840-440q0 75-28.5 140.5t-77 114q-48.5 48.5-114 77T480-80ZM360-320v-180h-60v-60h120v240h-60Zm140 0q-17 0-28.5-11.5T460-360v-160q0-17 11.5-28.5T500-560h80q17 0 28.5 11.5T620-520v160q0 17-11.5 28.5T580-320h-80Zm20-60h40v-120h-40v120Z";
        const likePath = "M720-120H280v-520l280-280 50 50q7 7 11.5 19t4.5 23v14l-44 174h258q32 0 56 24t24 56v80q0 7-2 15t-4 15L794-168q-9 20-30 34t-44 14Zm-360-80h360l120-280v-80H480l54-220-174 174v406Zm0-406v406-406Zm-80-34v80H160v360h120v80H80v-520h200Z";
        const likeFilledPath = "M720-120H280v-520l280-280 50 50q7 7 11.5 19t4.5 23v14l-44 174h258q32 0 56 24t24 56v80q0 7-2 15t-4 15L794-168q-9 20-30 34t-44 14Zm-440-520v80H160v360h120v80H80v-520h200Z";

        let longPressTimer;
        let mode = 'like'; // Default mode
        let liked = false;

        const updateIcon = () => {
            if (mode === 'equalizer') {
                optionIconPath.setAttribute('d', equalizerPath);
            } else if (mode === 'rewind') {
                optionIconPath.setAttribute('d', rewindPath);
            } else {
                optionIconPath.setAttribute('d', liked ? likeFilledPath : likePath);
            }
        };

        const toggleMode = () => {
            if (mode === 'like') {
                mode = 'equalizer';
            } else if (mode === 'equalizer') {
                mode = 'rewind';
            } else {
                mode = 'like';
            }
            if (navigator.vibrate) navigator.vibrate(500);

            // Visual feedback
            optionButton.classList.add('pulse');
            setTimeout(() => optionButton.classList.remove('pulse'), 300);

            updateIcon();
        };

        const toggleLike = () => {
            if (mode === 'like') {
                liked = !liked;
                updateIcon();
            } else if (mode === 'rewind') {
                audio.currentTime = Math.max(0, audio.currentTime - 10);
            }
        };

        let longPressTriggered = false;

        const triggerOutlineAnimation = () => {
            optionButton.classList.remove('animate-outline');
            // Force reflow
            void optionButton.offsetWidth;
            optionButton.classList.add('animate-outline');
        };

        const startPress = (e) => {
            longPressTriggered = false;
            longPressTimer = setTimeout(() => {
                longPressTriggered = true;
                triggerOutlineAnimation();
                toggleMode();
            }, 500); // 500ms for long press
        };

        const cancelPress = () => {
            clearTimeout(longPressTimer);
        };

        optionButton.addEventListener('mousedown', startPress);
        optionButton.addEventListener('touchstart', startPress);
        optionButton.addEventListener('mouseup', cancelPress);
        optionButton.addEventListener('mouseleave', cancelPress);
        optionButton.addEventListener('touchend', cancelPress);
        optionButton.addEventListener('contextmenu', (e) => e.preventDefault());
        optionButton.addEventListener('animationend', () => {
            optionButton.classList.remove('animate-outline');
        });

        optionButton.addEventListener('click', (e) => {
            if (longPressTriggered) return;
            toggleLike();
        });

        // Initialize icon
        updateIcon();
    </script>
</body>

</html>