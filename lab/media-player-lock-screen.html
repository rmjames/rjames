<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Media Player Lock Screen</title>
    <link rel="stylesheet" href="../styles/components/media-player.css">
    <style>
        :root {
            --widget-width: 20rem;
            --widget-height: 9.4rem;
        }

        body {
            background-color: oklch(from #1a1a1a l c h) !important;
            margin: 0;
            display: grid;
            place-items: center;
            min-height: 100vh;
        }

        .media-player-grid {
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            gap: 0.5rem;
            padding: .5rem;
            inline-size: var(--widget-width);
            block-size: var(--widget-height);
            background: linear-gradient(oklch(from #2a2a2a l c h / 0.8), oklch(from #2a2a2a l c h / 0.8)), var(--bg-image, none);
            background-size: cover;
            background-position: center;
            backdrop-filter: blur(10px);
            border-radius: 1.5rem;
            border: 1px solid oklch(from #444 l c h / 0.5);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            transition: background-image 0.5s ease-in-out;
            overflow: clip;
        }

        .media-player__equalizer {
            position: absolute;
            inset: 0;
            background: oklch(from #1a1a1a l c h / 0.9);
            backdrop-filter: blur(20px);
            border-radius: inherit;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            opacity: 0;
            pointer-events: none;
            transform: scale(0.95);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 20;
        }

        .media-player__equalizer.active {
            opacity: 1;
            pointer-events: all;
            transform: scale(1);
        }

        .eq-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #fff;
            flex-shrink: 0;
        }

        .eq-header h3 {
            margin: 0;
            font-size: 0.875rem;
            font-weight: 500;
            letter-spacing: 0.025em;
        }

        .eq-close {
            background: transparent !important;
            border: none !important;
            padding: 0 !important;
            inline-size: 1.5rem !important;
            block-size: 1.5rem !important;
            opacity: 0.7;
            transition: opacity 0.2s ease !important;
        }

        .eq-close:hover {
            opacity: 1;
        }

        .eq-close svg {
            inline-size: 18px !important;
            block-size: 18px !important;
        }

        .eq-grid {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 0.5rem;
            align-items: stretch;
            min-height: 0;
        }

        .media-player__equalizer__slider {
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }

        .media-player-grid__row {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 0.5rem;
            width: 100%;
            align-items: center;
        }

        .media-player-grid__row:nth-child(2) {
            margin-block-start: 0.5rem;
        }

        .grid-item--eq,
        .grid-item--phone {
            grid-column: 1;
            inline-size: 1.5rem !important;
            block-size: 1.5rem !important;
            padding: initial !important;
        }

        .grid-item--phone {
            grid-column: 8;
        }

        .grid-item--eq svg,
        .grid-item--phone svg {
            inline-size: 16px;
            block-size: 16px;
        }

        .media-player__meta {
            grid-column: 1 / 8;
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 0.125rem;
            padding-inline-start: 0.25rem;
            min-inline-size: 0;
        }

        .media-player__play-pause {
            grid-column: 8;
            inline-size: 2.5rem !important;
            block-size: 2rem !important;
            border-radius: .75rem !important;
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) !important;
        }

        .media-player__play-pause svg {
            inline-size: 24px !important;
            block-size: 24px !important;
        }

        .media-player__play-pause:active {
            transform: scale(1.1);
        }

        .media-player__prev {
            grid-column: 1;
        }

        .media-player__progress {
            grid-column: 2 / 6;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .media-player__next {
            grid-column: 6;
        }

        .media-player__like {
            grid-column: 7;
        }

        .media-player__random {
            grid-column: 8;
        }

        .media-player-grid button {
            background: transparent;
            border: none;
            border-radius: 0.75rem;
            color: white;
            padding: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            inline-size: 2rem;
            block-size: 2rem;
            aspect-ratio: 1;
        }

        .media-player-grid .themed-background {
            background: var(--themed-background, oklch(from #007bff l c h));
            border-radius: 1rem;
            transition: background-color 0.5s ease;
        }

        .media-player__meta__title {
            font-size: 0.875rem;
            font-weight: 600;
            color: #fff;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .media-player__meta__artist {
            font-size: 0.75rem;
            color: #aaa;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .progress-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            background: transparent;
            outline: none;
            cursor: pointer;
            height: 16px;
            display: flex;
            align-items: center;
        }

        .progress-slider::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            background: #444;
            border-radius: 2px;
            border: none;
        }

        .progress-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 4px;
            height: 16px;
            background: oklch(from #fff l c h / 0.8);
            border-radius: 2px;
            cursor: pointer;
            margin-top: -6px;
            /* (4px track / 2) - (16px thumb / 2) = -6 */
            border: none;
        }

        svg {
            inline-size: 20px;
            block-size: 20px;
            fill: currentColor;
        }

        .icon-btn--brand svg {
            fill: oklch(from #fff l c h / 0.8);
        }
    </style>
</head>

<body>

    <section class="media-player-grid">
        <article class="media-player-grid__row">
            <button class="grid-item--eq icon-btn--brand themed-background" title="Equalizer">
                <svg viewBox="0 -960 960 960" xmlns="http://www.w3.org/2000/svg">
                    <path
                        d="M280-240v-480h80v480h-80ZM440-80v-800h80v800h-80ZM120-400v-160h80v160h-80Zm480 160v-480h80v480h-80Zm160-160v-160h80v160h-80Z" />
                </svg>
            </button>
            <button class="grid-item--phone icon-btn--brand themed-background" title="This Phone">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path
                        d="M17 1H7c-1.1 0-2 .9-2 2v18c0 1.1.9 2 2 2h10c1.1 0 2-.9 2-2V3c0-1.1-.9-2-2-2zm0 18H7V5h10v14z" />
                </svg>
            </button>
        </article>
        <article class="media-player-grid__row">
            <div class="media-player__meta">
                <div class="media-player__meta__title">Loading...</div>
                <div class="media-player__meta__artist">...</div>
            </div>
            <button class="media-player__play-pause themed-background" title="Play">
                <svg viewBox="0 -960 960 960">
                    <path d="M320-200v-560l440 280-440 280Zm80-280Zm0 134 210-134-210-134v268Z" />
                </svg>
            </button>
        </article>
        <article class="media-player-grid__row">
            <button class="media-player__prev" title="Previous">
                <svg viewBox="0 -960 960 960">
                    <path d="M240-240v-480h80v480h-80Zm440 0L400-480l280-240v480Z" />
                </svg>
            </button>
            <div class="media-player__progress">
                <input type="range" class="progress-slider" min="0" max="100" value="0">
            </div>
            <button class="media-player__next" title="Next">
                <svg viewBox="0 -960 960 960">
                    <path d="M640-240v-480h80v480h-80ZM280-240v-480l280 240-280 240Z" />
                </svg>
            </button>
            <button class="media-player__like" title="Like">
                <svg viewBox="0 -960 960 960">
                    <path
                        d="M720-120H280v-520l280-280 50 50q7 7 11.5 19t4.5 23v14l-44 174h258q32 0 56 24t24 56v80q0 7-2 15t-4 15L794-168q-9 20-30 34t-44 14Zm-360-80h360l120-280v-80H480l54-220-174 174v406Zm0-406v406-406Zm-80-34v80H160v360h120v80H80v-520h200Z" />
                </svg>
            </button>
            <button class="media-player__random" title="Random">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path
                        d="M10.59 9.17L5.41 4 4 5.41l5.17 5.17 1.42-1.41zM14.5 4l2.04 2.04L4 18.59 5.41 20 17.96 7.45 20 9.5V4h-5.5zm.59 11.59l-1.41-1.41-1.42 1.41 1.42 1.41 1.41-1.41z" />
                </svg>
            </button>
        </article>
        <div class="media-player__equalizer">
            <div class="eq-header">
                <h3>Equalizer</h3>
                <button class="eq-close" title="Close">
                    <svg viewBox="0 -960 960 960">
                        <path
                            d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z" />
                    </svg>
                </button>
            </div>
            <div class="eq-grid">
                <!-- Dynamically populated sliders -->
            </div>
        </div>
    </section>

    <audio id="audio-player"></audio>

    <script type="module">
        import { MediaPlayerCore } from '../scripts/media/MediaPlayerCore.js';
        import { Equalizer } from '../scripts/media/Equalizer.js';
        import { UI } from '../scripts/media/MediaPlayerUI.js';
        import { SVG_PATHS, EQ_CONFIG } from '../scripts/media/Constants.js';

        const audio = document.getElementById('audio-player');
        const core = new MediaPlayerCore(audio);
        const eq = new Equalizer(audio);

        const container = document.querySelector('.media-player-grid');
        const eqContainer = document.querySelector('.media-player__equalizer');
        const eqGrid = document.querySelector('.eq-grid');
        const eqBtn = document.querySelector('.grid-item--eq');
        const eqCloseBtn = document.querySelector('.eq-close');

        const titleEl = document.querySelector('.media-player__meta__title');
        const artistEl = document.querySelector('.media-player__meta__artist');
        const playBtn = document.querySelector('.media-player__play-pause');
        const prevBtn = document.querySelector('.media-player__prev');
        const nextBtn = document.querySelector('.media-player__next');
        const likeBtn = document.querySelector('.media-player__like');
        const randomBtn = document.querySelector('.media-player__random');
        const slider = document.querySelector('.progress-slider');

        let isLiked = false;
        let isRandom = false;

        // Init EQ
        EQ_CONFIG.forEach((config, index) => {
            const sliderWrapper = document.createElement('div');
            sliderWrapper.className = 'media-player__equalizer__slider';
            sliderWrapper.innerHTML = `
                <div class="eq-slider__wrapper">
                    <div class="eq-slider__track"></div>
                    <div class="eq-slider__fill"></div>
                    <div class="eq-slider__thumb"></div>
                    <input type="range" min="-12" max="12" value="0" step="0.1" aria-label="${config.label}">
                </div>
                <span class="eq-slider__label">${config.label}</span>
            `;
            const input = sliderWrapper.querySelector('input');
            input.addEventListener('input', (e) => {
                eq.setGain(index, parseFloat(e.target.value));
                UI.updateSliderVisuals(e.target);
            });
            eqGrid.appendChild(sliderWrapper);
            UI.updateSliderVisuals(input);
        });

        eqBtn.addEventListener('click', () => {
            eq.init();
            eq.resume();
            eqContainer.classList.add('active');
        });

        eqCloseBtn.addEventListener('click', () => {
            eqContainer.classList.remove('active');
        });

        core.subscribe((event, data) => {
            if (event === 'trackChanged') {
                titleEl.textContent = data.title;
                artistEl.textContent = data.artist;
                slider.value = 0;
                UI.updateBackgroundArt(container, data);
                UI.applyAccentColor(container, data, '--themed-background');
            }
            if (event === 'play' || event === 'pause') {
                UI.updatePlayIcon(playBtn, audio.paused);
            }
        });

        // Time Update
        audio.addEventListener('timeupdate', () => {
            if (!audio.duration) return;
            const progress = (audio.currentTime / audio.duration) * 100;
            slider.value = progress;
        });

        slider.addEventListener('input', () => {
            if (!audio.duration) return;
            const time = (slider.value / 100) * audio.duration;
            audio.currentTime = time;
        });

        playBtn.addEventListener('click', () => core.togglePlay());
        prevBtn.addEventListener('click', () => core.prev());
        nextBtn.addEventListener('click', () => core.next());

        likeBtn.addEventListener('click', () => {
            isLiked = !isLiked;
            const path = likeBtn.querySelector('svg path');
            path.setAttribute('d', isLiked ? SVG_PATHS.LIKE_FILLED : SVG_PATHS.LIKE);
            likeBtn.style.color = isLiked ? 'oklch(0.6 0.2 260 / 0.8)' : 'white';
        });

        randomBtn.addEventListener('click', () => {
            isRandom = !isRandom;
            randomBtn.style.color = isRandom ? 'oklch(0.6 0.2 260 / 0.8)' : 'white';
            if (isRandom) core.shuffle();
        });

        core.loadTrack(0);
    </script>
</body>

</html>